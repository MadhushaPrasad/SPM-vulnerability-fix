import React, { useState, useEffect } from "react";
import axios from "axios";
import moment from "moment";
import { Modal } from "react-bootstrap";
import Swal from "sweetalert2";
import Eventviewmodal from "../eventReservationManagement/modals/eventView";
import UpdateEventModal from "../eventReservationManagement/modals/updateEvent";
import Header from "../../Header";

function ViewEvent() {

  const apiUrl = process.env.REACT_APP_API_BASE_URL;

  const [viewevent, setviewevent] = useState([]);
  const [search, setSearch] = useState("");

  const [modalData, setData] = useState([]);
  const [modalShow, setModalShow] = useState(false);

  const [modalDataDelete, setModalDataDelete] = useState([]);
  const [modalDeleteConfirm, setModalDeleteConfirm] = useState(false);
  const [modalDelete, setModalDelete] = useState(false);

  const [modalLoading, setModalLoading] = useState(false);

  const [modalDataUpdate, setModalDataUpdate] = useState([]);
  const [modalUpdate, setModalUpdate] = useState(false);

  useEffect(() => {
    function getEvent() {
      axios
        .get(apiUrl + `event/displayEvent`)
        .then((res) => {
          setviewevent(res.data.reverse());
        })
        .catch((error) => {
          // alert(error.message);
          console.log("f354754", error);
          Swal.fire({
            icon: "error",
            title: "Oops...",
            text: "Something went wrong!",
            confirmButtonColor: "#207159",
          });
        });
    }

    getEvent();
  }, []);

  useEffect(() => {
    //console.log("component did update", modalDataDelete)
  }, [modalDataDelete]);

  const openModal = (reservations) => {
    setData(reservations);
    handleViewOnClick();
  };

  const handleViewOnClick = () => {
    setModalShow(true);
  };

  //set delete modal
  const openModalDelete = (data) => {
    setModalDataDelete(data);
    setModalDeleteConfirm(true);
  };

  //set update modal
  const openModalUpdate = (data) => {
    //console.log("request came for modal updateeeeeee", data);
    setModalDataUpdate(data);
    setModalUpdate(true);
  };

  // //search all completed record after clicking completed button
  function pendingRecords() {
      function getPendingReservation() {
          axios.get(apiUrl + "event/searchCompletedEventRecords/").then((res) => {
              setviewevent(res.data.reverse());
          }).catch((error) => {
              alert(error.message);
          })
      }
      getPendingReservation();
  }

  //search customer nic and package name after the search
  function searchEvent(e) {
    e.preventDefault();
    if (!isNaN(search.charAt(0))) {
      axios
        .get(apiUrl + `event/searchEventRecs/${search}`)
        .then((res) => {
          setviewevent(res.data);
        })
        .catch((error) => {
          alert(error.message);
        });
    } else {
      axios
        .get(apiUrl + `event/searchEventRecordsX/${search}`)
        .then((res) => {
          setviewevent(res.data);
        })
        .catch((error) => {
          alert(error.message);
        });
    }
  }

  //handle delete from reservation and add to the remove reservation list
  function deleteReservation(data) {
    axios
      .post(apiUrl + `removedEvent/addRemovedReservation`, {
        data,
      })
      .then(() => {
        Swal.fire({
          title: "Completed Reservation removed! ",
          text: "Reservation removed",
          icon: "success",
          confirmButtonColor: "#207159",
        });

        const value = axios.post(
          apiUrl + `event/deleteEvent`,
          modalDataDelete
        );

        if (value) {
          Swal.fire({
            title: "Success!",
            text: `${"Reservation Deleted Successfully"}`,
            icon: "success",
            showConfirmButton: false,
            timer: 2000,
          }).then(() => {
            window.location.reload();
          });
        }
      })
      .catch((err) => {
        Swal.fire({
          title: "Oops!",
          text: `${"Reservation not Completed"}`,
          icon: "error",
          showConfirmButton: false,
          timer: 1500,
        });
      });
  }

  //refresh the page
  function refreshPage() {
    window.location.reload();
  }

  return (
    <div className="page-component-body">
      <Header></Header>
      <Modal
        show={modalShow}
        onHide={() => setModalShow(false)}
        size="lg"
        aria-labelledby="contained-modal-title-vcenter"
        centered
      >
        <Eventviewmodal data={modalData} onHide={() => setModalShow(false)} />
      </Modal>
      <div className="table-emp">
        <div className="row table-head">
          <div className="col">
            <h3 className="float-left" onClick={refreshPage}>
              List of Reservation
            </h3>
          </div>

          <a href="/addEvent" className="float-right">
            <button className="btn btn-ok white">+Add Reservation</button>
          </a>
          <p className="float-right ml-4">
            <button className="btn btn-ok white" id="pending" onClick={pendingRecords}>
              Completed Reservation
            </button>
          </p>
          <a href="/display/RemoveEventlist" className="float-right ml-4" >
            <button className="btn btn-ok white">Past Records</button>
          </a>
        </div>
        <div className="row table-head-search">
          <div className="col-md-8"></div>
          <div className="col">
            <div className="input-group input-group-search">
              <div className="searchbar">
                <form onSubmit={searchEvent}>
                  <input
                    className="search_input"
                    type="text"
                    name="search"
                    placeholder="Search..."
                    value={search}
                    onChange={(event) => {
                      setSearch(event.target.value);
                    }}
                    require
                  />
                  <button
                    className="btn search_icon"
                    id="submit"
                    name="submit"
                    type="submit"
                  >
                    <i className="fa fa-search"></i>
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
        <table className="table table-hover" id="myTable">
          <thead className="thead-dark">
            <tr>
              <th className="text">Customer</th>
              <th className="text">NIC</th>
              <th className="text">Package Name</th>
              <th className="text">Event Type</th>
              <th className="text">From</th>
              <th className="text">To</th>
              <th className="text-center">Total</th>
              <th className="text-right">Status</th>
              <th className="text-center">Action</th>
            </tr>
          </thead>
          <tbody>
            {viewevent.map((reservations) => {
              return (
                <tr>
                  <td
                    className="text"
                    onClick={() => openModal(reservations)}
                    data-toggle="tooltip"
                    data-placement="right"
                    title="Click to view reservation"
                  >
                    {reservations.customername}
                  </td>
                  <td className="text">{reservations.customernic}</td>
                  <td className="text">{reservations.packagename}</td>
                  <td className="text">{reservations.eventtype}</td>
                  <td className="text">
                    {moment(reservations.from).format("YYYY-MMMM-DD")}
                  </td>
                  <td className="text">
                    {moment(reservations.to).format("YYYY-MMMM-DD")}
                  </td>
                  <td className="text-right">
                    {reservations.totalreservation.toFixed(2)}
                  </td>
                  <td className="text-right">{reservations.status}</td>
                  <td className="text">
                    <div
                      className="btn-group"
                      role="group"
                      aria-label="Basic example"
                    >
                      <button
                        className="btn btn-light btn-sm"
                        onClick={() => openModalUpdate(reservations)}
                      >
                        update
                      </button>

                      <button
                        className="btn btn-danger btn-sm"
                        onClick={() => {
                          openModalDelete(reservations);
                        }}
                        role="button"
                      >
                        remove
                      </button>
                    </div>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      <Modal
        show={modalDeleteConfirm}
        size="md"
        aria-labelledby="contained-modal-title-vcenter"
        centered
      >
        <Modal.Header closeButton>
          <Modal.Title>Confirm Deletion</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <p>Are you want to delete this item ?</p>
        </Modal.Body>
        <Modal.Footer>
          <div className="row">
            <div className="col -6">
              <button
                type="submit"
                className="btn btn-delete"
                onClick={() => {
                  deleteReservation(modalDataDelete);
                }}
              >
                Confirm
              </button>
            </div>
            <div
              className="col-6   text-right"
              onClick={() => setModalDeleteConfirm(false)}
            >
              <button type="reset" className="btn btn-reset">
                cancel
              </button>
            </div>
          </div>
        </Modal.Footer>
      </Modal>
      {/* modal for display while loading or on error */}

      <Modal
        show={modalLoading}
        size="sm"
        aria-labelledby="contained-modal-title-vcenter"
        centered
      >
        <Modal.Body>
          <div className="d-flex justify-content-center mt-2">
            <div className="spinner-grow text-danger" role="status"></div>
            <div className="spinner-grow text-danger" role="status"></div>
            <div className="spinner-grow text-danger" role="status"></div>

            <span className="sr-only">something went wrong...</span>
          </div>
          <div className="d-flex justify-content-center mt-4 h5">
            {" "}
            something went wrong
          </div>
        </Modal.Body>
        <Modal.Footer>
          <div className="col py-3 text-center">
            <button
              type="submit"
              className="btn btn-delete"
              onClick={() => {
                window.location.reload();
              }}
            >
              Try again
            </button>
          </div>
        </Modal.Footer>
      </Modal>

      {/* modal for update the data of Event */}
      <Modal
        show={modalUpdate}
        onHide={() => setModalUpdate(false)}
        size="lg"
        aria-labelledby="contained-modal-title-vcenter"
        centered
      >
        <UpdateEventModal
          data={modalDataUpdate}
          onHide={() => setModalUpdate(false)}
        />
      </Modal>
    </div>
  );
}

export default ViewEvent;
